# Design Doc 6: Monorepo 構成 & ビルド戦略

複数のサービスを 1 つのリポジトリで管理するため、以下のルールを定めます。

## 1. ディレクトリ構造

```bash
celo/
├── go.work              # Go Workspaces 定義
├── package.json         # Node.js Workspaces 定義
├── proto/               # Single Source of Truth
│   ├── buf.yaml
│   └── schema/v1/       # .proto ファイル群
├── pkg/
│   └── gen/             # 生成コード (Go/TS) ※各サービスから参照
│       ├── go/          # Go 生成コード (go.mod なし)
│       └── ts/          # TypeScript 生成コード
├── services/
│   ├── isr/             # Go: Schema Registry
│   │   └── go.mod       # pkg/gen/go を参照
│   ├── be/              # Go: Main Backend
│   │   └── go.mod       # pkg/gen/go を参照
│   ├── bff/             # Node.js: Connect Proxy
│   └── fe/              # React: Frontend
├── tests/
│   ├── integration/     # Go: Testcontainers Integration Tests
│   │   └── go.mod       # pkg/gen/go を参照
│   └── e2e/             # TS: Playwright Scenarios
├── scripts/             # 開発用補助スクリプト
├── init-db/             # DB 初期化スクリプト
└── docker-compose.yml

```

## 2. 依存管理のルール

* **Go**: ルートに `go.work` (Go Workspaces) を置き、`pkg/gen/go`, `services/isr`, `services/be`, `tests/integration` をマルチモジュールとして管理。`pkg/gen/go` には `go.mod` を置き、生成コード専用の独立モジュールとして管理することで、依存関係の明示化とIDEサポートを強化。
* **Node.js**: ルートに `package.json` を置き、npm workspaces を使って `services/bff`, `services/fe`, `tests/e2e` を管理。
* **Proto**: `buf generate` の出力先を共通の `pkg/gen/` ディレクトリに集約し、各サービスはそこから import する。

## 3. CI 戦略 (GitHub Actions)

* **Path-based trigger**: `services/be/**` が変更されたときのみ BE のテストを走らせるなど、無駄なビルドを避ける設定を行う。
