# Design Doc 4: データモデル & API インターフェース (DB 分離版)

## 1. データベース構成

1 つの PostgreSQL コンテナ内に 2 つの独立したデータベースを作成します。

* **Database: `irs**` (Internal Schema Registry 用)
* `schemas` テーブルを保持。


* **Database: `be**` (Backend ビジネスロジック用)
* `users`, `posts` テーブルを保持。



### 1.1 `irs.schemas`

```sql
CREATE TABLE schemas (
    id          UUID PRIMARY KEY,
    major       INTEGER NOT NULL,
    minor       INTEGER NOT NULL,
    patch       INTEGER NOT NULL,
    full_tag    TEXT NOT NULL,
    descriptor  BYTEA NOT NULL,
    created_at  TIMESTAMP WITH TIME ZONE NOT NULL,
    UNIQUE(major, minor, patch)
);

```

### 1.2 `be.users` & `be.posts`

集約外のため、FK（外部キー制約）はあえて設けず、アプリケーションレイヤーで整合性を管理します。

```sql
-- be.users
CREATE TABLE users (
    id         UUID PRIMARY KEY,
    name       VARCHAR(100) NOT NULL,
    plan       VARCHAR(20) NOT NULL CHECK (plan IN ('free', 'premium')),
    created_at TIMESTAMP WITH TIME ZONE NOT NULL
);

-- be.posts
CREATE TABLE posts (
    id         UUID PRIMARY KEY,
    user_id    UUID NOT NULL, -- FKなし
    message    TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL
);

```

---

## 2. 実装の準備: `docker-compose.yml` と初期化

PostgreSQL は起動時に `/docker-entrypoint-initdb.d/` にある `.sql` または `.sh` を実行します。これを利用して、複数の DB を自動生成します。

### 2.1 初期化スクリプト案 (`init.sh`)

```bash
#!/bin/bash
set -e

psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
    CREATE DATABASE irs;
    CREATE DATABASE be;
EOSQL

```

### 2.2 `docker-compose.yml` のイメージ

```yaml
services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - ./init-db:/docker-entrypoint-initdb.d # 上記 init.sh を配置
    ports:
      - "5432:5432"

```

---

## 3. UUID v7 の実装方針 (再確認)

* **生成タイミング**:
* `CreateUser`, `CreatePost` のリクエストを FE/BFF が投げる瞬間に生成。
* `UploadSchema` のスクリプトを実行する瞬間に生成。


* **バリデーション**: BE では送られてきた UUID が正しい形式（v7 形式のチェックはライブラリで可能）であることを確認し、DB に保存。

---

## 4. プロジェクトのディレクトリ構成 (Final)

```bash
celo/
├── init-db/             # DB初期化スクリプト
├── proto/               # .protoファイル群
├── scripts/             # upload_schema.sh (UUID v7生成 & ISRへPost)
├── services/
│   ├── isr/             # ISR (Connect to irs)
│   ├── be/              # BE (Connect to be)
│   ├── bff/             # BFF (Node.js)
│   └── fe/              # FE (React/TypeScript)
└── docker-compose.yml

```
