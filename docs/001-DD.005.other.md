# Design Doc 5: 実装ガイドライン & 運用仕様 (Implementation & Ops)

## 1. エラーハンドリング詳細 (Error Specification)

バリデーションエラー（`INVALID_ARGUMENT`）発生時、FE が動的にメッセージを組み立てられるよう、`google.rpc.BadRequest` に準拠した詳細情報を付与する。

### 1.1 Field Violation の構造

各エラーには以下の情報をパッキングする。

* **field**: エラーが発生したフィールド名（例: `message`）。
* **message_id**: FE での翻訳キー（例: `CELO_V1_POST_MESSAGE_LIMIT`）。CEL の constraint に設定した `id`（例: `post.message.limit`）を基に BE/BFF で生成。
* **payload (JSON)**: CEL 式から渡される動的なパラメータ。
  * 例: `{"user_plan": "free", "limit": "100"}`

### 1.2 message_id の自動生成ルール

CEL の `id` を以下のルールで変換し、グローバルにユニークな `message_id` を生成する。

* **変換ルール**:
  1. package name を prefix として追加（例: `celo.v1` → `CELO_V1`）
  2. id をアッパースネークケースに変換（例: `post.message.limit` → `POST_MESSAGE_LIMIT`）
  3. 結合して `PACKAGE_PREFIX_ID` の形式にする

* **例**:
  * CEL id: `post.message.limit`, package: `celo.v1` → `CELO_V1_POST_MESSAGE_LIMIT`
  * CEL id: `user.name.required`, package: `celo.v1` → `CELO_V1_USER_NAME_REQUIRED`

* **理由**: 将来的に proto file が複数になったり、複数の BE サービスが登場する可能性があるため、package name を含めることでグローバルにユニークな ID を保証する。

### 1.3 エラーレスポンス例

BE/BFF から返されるエラーレスポンス:

```json
{
  "code": "INVALID_ARGUMENT",
  "message": "Validation failed",
  "details": [
    {
      "field": "message",
      "message_id": "CELO_V1_POST_MESSAGE_LIMIT",
      "payload": {
        "user_plan": "free",
        "limit": "100"
      }
    }
  ]
}
```

### 1.4 FE での国際化処理

FE は `message_id` をキーとして、辞書ファイルから多言語メッセージを取得し、`payload` の値をテンプレートに埋め込む。

**翻訳ファイル例 (`i18n/ja.json`)**:

```json
{
  "CELO_V1_POST_MESSAGE_LIMIT": "ユーザープランが ${user_plan} の場合、ポストは ${limit} 文字までです。"
}
```

**翻訳ファイル例 (`i18n/en.json`)**:

```json
{
  "CELO_V1_POST_MESSAGE_LIMIT": "If the user plan is ${user_plan}, the post can be up to ${limit} characters."
}
```

**FE での表示結果（日本語）**:

```text
ユーザープランが free の場合、ポストは 100 文字までです。
```

---

## 2. スキーマ同期プロトコル (Sync Lifecycle)

### 2.1 更新 (Registry Update)

* **方式**: Push 型（Local Script による手動更新）。
* **トリガー**: 開発者がスクリプトを実行した瞬間、ISR の DB が更新される。
* **バリデーション**: PoC フェーズではバイナリの整合性チェックをスキップし、開発者の SemVer 遵守に依存する。

### 2.2 同期 (Client Polling)

FE, BFF, BE はそれぞれ独立して ISR (または BFF proxy) に対してポーリングを行う。

* **間隔**: 一律 **1分 (60s)**。
* **ヘッダー**: すべてのレスポンスの HTTP Header に `X-Schema-Version` (例: `1.0.5`) を付与し、テストの可観測性を高める。

---

## 3. 運用・デバッグ仕様 (Observability)

### 3.1 ログ出力規約

各コンポーネントは以下のタイミングで標準出力にログを出す。

* **起動時**: ターゲットとする `Major.Minor` バージョンを明示。
* **更新検知時**: スキーマの Patch バージョンが上がった際、`Hot-swapped validator: v1.0.4 -> v1.0.5` と出力。

### 3.2 セキュリティ・ガードレール

* **BE Authoritative**: クライアントから送られた `user_plan` フィールドは、BE のバリデーション直前に DB の値で必ず上書きする。
* **Fail-safe**: ISR との通信が途絶した場合、各サービスは最後に成功したスキーマ（インメモリキャッシュ）を使用してバリデーションを継続する。

---

## 4. 特記事項 (All Yes)

* Startup Log の出力：**Yes**
* Update Log の出力：**Yes**
* Response Header へのバージョン付与：**Yes**
