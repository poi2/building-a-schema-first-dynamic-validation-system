# Design Doc 5: 実装ガイドライン & 運用仕様 (Implementation & Ops)

## 1. エラーハンドリング詳細 (Error Specification)

バリデーションエラー（`INVALID_ARGUMENT`）発生時、FE が動的にメッセージを組み立てられるよう、`google.rpc.BadRequest` に準拠した詳細情報を付与する。

### 1.1 Field Violation の構造

各エラーには以下の情報をパッキングする。

* **field**: エラーが発生したフィールド名（例: `message`）。
* **message_id**: FE での翻訳キー（例: `error.post.message_limit`）。
* **payload (JSON)**: CEL 式から渡される動的なパラメータ。
* 例: `{"current": 150, "limit": 100, "plan": "free"}`



---

## 2. スキーマ同期プロトコル (Sync Lifecycle)

### 2.1 更新 (Registry Update)

* **方式**: Push 型（Local Script による手動更新）。
* **トリガー**: 開発者がスクリプトを実行した瞬間、ISR の DB が更新される。
* **バリデーション**: PoC フェーズではバイナリの整合性チェックをスキップし、開発者の SemVer 遵守に依存する。

### 2.2 同期 (Client Polling)

FE, BFF, BE はそれぞれ独立して ISR (または BFF proxy) に対してポーリングを行う。

* **間隔**: 一律 **1分 (60s)**。
* **ヘッダー**: すべてのレスポンスの HTTP Header に `X-Schema-Version` (例: `1.0.5`) を付与し、テストの可観測性を高める。

---

## 3. 運用・デバッグ仕様 (Observability)

### 3.1 ログ出力規約

各コンポーネントは以下のタイミングで標準出力にログを出す。

* **起動時**: ターゲットとする `Major.Minor` バージョンを明示。
* **更新検知時**: スキーマの Patch バージョンが上がった際、`Hot-swapped validator: v1.0.4 -> v1.0.5` と出力。

### 3.2 セキュリティ・ガードレール

* **BE Authoritative**: クライアントから送られた `_plan` フィールドは、BE のバリデーション直前に DB の値で必ず上書きする。
* **Fail-safe**: ISR との通信が途絶した場合、各サービスは最後に成功したスキーマ（インメモリキャッシュ）を使用してバリデーションを継続する。

---

## 4. 特記事項 (All Yes)

* Startup Log の出力：**Yes**
* Update Log の出力：**Yes**
* Response Header へのバージョン付与：**Yes**
