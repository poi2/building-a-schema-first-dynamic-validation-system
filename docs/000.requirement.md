# Building a Schema-First Dynamic Validation System

A proof-of-concept for a schema-first dynamic validation system using ConnectRPC and protovalidate, ensuring seamless contract synchronization across FE, BFF, and BE.

## 1. プロジェクト目的

* Single Source of Truth: `.proto`ファイルを唯一の正解とし、FE/BFF/BE全層でバリデーションロジックを同期する。
* Hot Reloading: アプリを再起動せず、実行時にスキーマ（バリデーションルール）を更新可能にする。
* Contract Programming: `protovalidate` (CEL) を用い、ユーザー属性（プラン）に応じた高度な相関バリデーションを宣言的に記述する。

## 2. システムアーキテクチャ

* 通信プロトコル: Connect (gRPC互換、HTTP/1.1 JSONを利用)
* スキーマ管理: GitHub Releases を「スキーマレジストリ」として利用。
* 配布モデル:
  1. GitHub Actionsで `descriptor.bin` をビルド・リリース。
  2. ISR（Internal Schema Registry） はキャッシュする
  2. BFF/BE は ISR から最新の proto を取得して validator を更新
  3. FE は BFF から最新の proto を取得して validator を更新

## 3. アプリケーション要件

### A. データモデル

* User: `id` (UUID), `name` (1-10文字), `plan` (free | premium)
* Post: `id` (UUID), `user_id` (UUID), `message` (string), `created_at` (timestamp)

### B. バリデーションルール (CEL)

* CreateUser: `name` の長さ制限。
* CreatePost:
* `free` ユーザー: `message` は 100文字以内。
* `premium` ユーザー: `message` は 300文字以内。
* ※BEではDBの値を優先し、メッセージを上書き補完した上で検証する。

### C. 各層の責務

1. FE (TS):
* ログイン/新規登録、投稿一覧（Streaming受取）、新規投稿。
* メモリ上の `plan` を使い、文字入力のたびに 即時バリデーション（ボタンの活性/非活性制御）。

2. BFF (TS):
* スキーマの定期取得と配信。
* リクエストを受け取った際、セッション情報（`plan`）を補完して 送信前バリデーション。

3. BE (Go):
* DB（PostgreSQL）から最新の `plan` を取得し、リクエストを補完して 最終バリデーション。
* 新着投稿を Server Streaming で配信。

## 4. 技術スタック詳細

* Frontend: TypeScript, React/Vue/Svelte, `@connectrpc/connect-web`
* BFF: Node.js, TypeScript, `@connectrpc/connect-node`, `protovalidate-ts`
* Backend: Go, `tonic` (Connect互換), `protovalidate-go`, `sqlx` (PostgreSQL)
* Infrastructure: Docker Compose, PostgreSQL

## 5. PoCで証明するシナリオ

1. 正常系: プレミアムユーザーが200文字の投稿に成功すること。
2. UX改善: フリーユーザーが101文字入力した瞬間に、送信ボタンが無効化されエラーコードに対応した日本語メッセージ（i18n）が出ること。
3. 動的更新: `descriptor.bin` を更新（例：free制限を50文字に変更）してリリースした際、数分以内に全コンテナが再起動なしで新しいルールを適用すること。
4. 防御: FEをバイパスして不正な `plan` でリクエストを投げても、BEのDB補完によって正しくRejectされること。
