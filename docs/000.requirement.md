# Building a Schema-First Dynamic Validation System

A proof-of-concept for a schema-first dynamic validation system using ConnectRPC and protovalidate, ensuring seamless contract synchronization across FE, BFF, and BE.

## 1. プロジェクト目的

* Single Source of Truth: `.proto`ファイルを唯一の正解とし、FE/BFF/BE全層でバリデーションロジックを同期する。
* ~~Hot Reloading: アプリを再起動せず、実行時にスキーマ（バリデーションルール）を更新可能にする。~~ **[検証結果]** protovalidateの技術的制約により実現不可。詳細は[Design Doc 3 § 7.1](001-DD.003.validation-strategy.md#71-実装結果と重要な制約事項)参照。
* Contract Programming: `protovalidate` (CEL) を用い、ユーザー属性（プラン）に応じた高度な相関バリデーションを宣言的に記述する。

## 2. システムアーキテクチャ

* 通信プロトコル: Connect (gRPC互換、HTTP/1.1 JSONを利用)
* スキーマ管理: ISR (Internal Schema Registry) を中央レジストリとして利用
* 配布モデル:
  1. ローカルスクリプトで `descriptor.bin` をビルド・ISRにアップロード
  2. ISR はスキーマをDBにキャッシュする
  3. BE は ISR から最新の proto を取得して validator を更新
  4. FE は BE から最新の proto を取得して validator を更新

## 3. アプリケーション要件

### A. データモデル

* User: `id` (UUID), `name` (1-10文字), `plan` (free | premium)
* Post: `id` (UUID), `user_id` (UUID), `message` (string), `created_at` (timestamp)

### B. バリデーションルール (CEL)

* CreateUser: `name` の長さ制限。
* CreatePost:
* `free` ユーザー: `message` は 100文字以内。
* `premium` ユーザー: `message` は 300文字以内。
* ※BEではDBの値を優先し、メッセージを上書き補完した上で検証する。

### C. 各層の責務

1. FE (TS):
   * ログイン/新規登録、投稿一覧（Streaming受取）、新規投稿。
   * メモリ上の `plan` を使い、文字入力のたびに 即時バリデーション（ボタンの活性/非活性制御）。
   * BE からスキーマを定期取得し、protovalidate-ts でバリデーション。

2. BE (Go):
   * DB（PostgreSQL）から最新の `plan` を取得し、リクエストを補完して 最終バリデーション。
   * 新着投稿を Server Streaming で配信。
   * FE へのスキーマ配信エンドポイントを提供（ISR からの取得をプロキシ）。

## 4. 技術スタック詳細

* Frontend: TypeScript, React/Vue/Svelte, `@connectrpc/connect-web`, `protovalidate-ts`
* Backend: Go, `connect-go`, `protovalidate-go`, `sqlx` (PostgreSQL)
* ISR: Go, `connect-go`, PostgreSQL
* Infrastructure: Docker Compose, PostgreSQL

## 5. PoCで証明するシナリオ

1. 正常系: プレミアムユーザーが200文字の投稿に成功すること。
2. UX改善: フリーユーザーが101文字入力した瞬間に、送信ボタンが無効化されエラーコードに対応した日本語メッセージ（i18n）が出ること。
3. ~~動的更新: `descriptor.bin` を更新（例：free制限を50文字に変更）してリリースした際、数分以内に全コンテナが再起動なしで新しいルールを適用すること。~~ **[検証結果]** protovalidateの制約により不可。スキーマ更新はリビルド・再デプロイが必要。ISRポーリング機構は実装済みだが、バリデーションルールの動的更新には使用できない。
4. 防御: FEをバイパスして不正な `plan` でリクエストを投げても、BEのDB補完によって正しくRejectされること。
