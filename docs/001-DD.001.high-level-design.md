# Design Doc 1: å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ (High-Level Design) - æ”¹è¨‚ç‰ˆ

## 1. èƒŒæ™¯ã¨èª²é¡Œ

ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã®é‡è¤‡ã€ä¸æ•´åˆã€ãŠã‚ˆã³æ›´æ–°æ™‚ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ã‚¹ãƒˆã‚’æ’é™¤ã™ã‚‹ãŸã‚ã€å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§å‹•çš„ã«åŒæœŸã•ã‚Œã‚‹ã€Œå¥‘ç´„é§†å‹•ï¼ˆContract-Drivenï¼‰ã€ãªã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

## 2. è¨­è¨ˆç›®æ¨™

* **Single Source of Truth**: `.proto` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å”¯ä¸€ã®æ­£è§£ã¨ã™ã‚‹ã€‚
* **Dynamic Schema Distribution**: ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•ãªã—ã§å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«ã‚’æ•°åˆ†ä»¥å†…ã«æ›´æ–°ã™ã‚‹ã€‚
* **Decoupled Registry**: GitHub ã®ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆã‚„èªè¨¼ã‚’éš è”½ã—ã€å†…éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«æœ€é©åŒ–ã•ã‚ŒãŸã‚¹ã‚­ãƒ¼ãƒé…ä¿¡ã‚’è¡Œã†ã€‚

## 3. ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

1. **Schema Source (GitHub)**: ã‚¹ã‚­ãƒ¼ãƒã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ç®¡ç†ã¨ã€CIã«ã‚ˆã‚‹ãƒã‚¤ãƒŠãƒªãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†ã€‚
2. **Internal Schema Registry (ISR) â˜…è¿½åŠ **:
* GitHub ã‹ã‚‰æœ€æ–°ã® `descriptor.bin` ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹**ãƒãƒ–**ã€‚
* BE / BFF ã«å¯¾ã—ã¦ã€ä¸€è²«ã—ãŸã‚¹ã‚­ãƒ¼ãƒé…ä¿¡ API ã‚’æä¾›ã™ã‚‹ã€‚


3. **BFF (TypeScript / Connect-Node)**:
* ISR ã‹ã‚‰ã‚¹ã‚­ãƒ¼ãƒã‚’å–å¾—ãƒ»ä¿æŒã€‚
* ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆFEï¼‰å‘ã‘ã«ã‚¹ã‚­ãƒ¼ãƒã‚’ãƒ—ãƒ­ã‚­ã‚·é…ä¿¡ã™ã‚‹ã€‚


4. **Backend (Go / Connect-Go)**:
* ISR ã‹ã‚‰ã‚¹ã‚­ãƒ¼ãƒã‚’å–å¾—ã€‚
* DB ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ³¨å…¥ã—ãŸæœ€çµ‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã€‚


5. **Frontend (TypeScript / Connect-Web)**:
* BFF ã‚’çµŒç”±ã—ã¦ã‚¹ã‚­ãƒ¼ãƒã‚’å–å¾—ã€‚
* `protovalidate-ts` ã«ã‚ˆã‚‹å³æ™‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã€‚



## 4. ã‚¹ã‚­ãƒ¼ãƒé…å¸ƒãƒ»åŒæœŸã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

| ã‚¹ãƒ†ãƒƒãƒ— | å‹•ä½œå†…å®¹ | æ‹…å½“ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ |
| --- | --- | --- |
| **1. Build** | `.proto` æ›´æ–°ã‚’æ¤œçŸ¥ã— `descriptor.bin` ã‚’ãƒªãƒªãƒ¼ã‚¹ | GitHub Actions |
| **2. Fetch & Cache** | GitHub API ã‚’å©ãã€ãƒã‚¤ãƒŠãƒªã‚’ãƒ¡ãƒ¢ãƒª/ãƒ‡ã‚£ã‚¹ã‚¯ã«ä¿æŒ | **ISR** |
| **3. Sync (Server)** | ISR ã® API ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã€æ›´æ–°ãŒã‚ã‚Œã°ãƒ›ãƒƒãƒˆã‚¹ãƒ¯ãƒƒãƒ— | BE / BFF |
| **4. Sync (Client)** | BFF ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã€ãƒã‚¤ãƒŠãƒªã‚’ãƒ­ãƒ¼ãƒ‰ã€‚æ›´æ–°æ™‚ã¯ WebSocket/SSE ã§é€šçŸ¥ã‚‚é€ä¿¡ | FE |

### ã‚¹ã‚­ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´ã®è§£æ±ºæˆ¦ç•¥

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ»ã‚µãƒ¼ãƒãƒ¼é–“ã®ã‚¹ã‚­ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸ä¸€è‡´ã‚’é˜²ããŸã‚ã€ä»¥ä¸‹ã®ä»•çµ„ã¿ã‚’å°å…¥ã™ã‚‹ã€‚

1. **ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã§ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³é€šçŸ¥**:
   * ã™ã¹ã¦ã® API ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« `X-Schema-Version` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸ï¼ˆä¾‹: `1.0.5`ï¼‰ã€‚

2. **ä¸ä¸€è‡´æ¤œå‡ºæ™‚ã®è‡ªå‹•åŒæœŸ**:
   * FE ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡æ™‚ã€ãƒ¡ãƒ¢ãƒªä¸Šã®ã‚¹ã‚­ãƒ¼ãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ `X-Client-Schema-Version` ã«å«ã‚ã‚‹ã€‚
   * BFF/BE ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã® `X-Schema-Version` ã¨æ¯”è¼ƒã—ã€è‡ªèº«ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ã„å ´åˆï¼š
     1. å³åº§ã« ISR ã‹ã‚‰æœ€æ–°ã® Patch ã‚’ fetch ã™ã‚‹ã€‚
     2. fetch ã§ããªã‹ã£ãŸã€ã¾ãŸã¯ fetch ã—ã¦ã‚‚å¤ã„å ´åˆã¯ã€ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™ï¼ˆ`UNAVAILABLE` ã¾ãŸã¯ `FAILED_PRECONDITION`ï¼‰ã€‚
   * FE ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã® `X-Schema-Version` ã‚’ç¢ºèªã—ã€è‡ªèº«ã‚ˆã‚Šæ–°ã—ã„å ´åˆã¯å³åº§ã« BFF ã‹ã‚‰ã‚¹ã‚­ãƒ¼ãƒã‚’å†å–å¾—ã€‚

3. **ãƒ—ãƒ­ã‚¢ã‚¯ãƒ†ã‚£ãƒ–é€šçŸ¥ (WebSocket/SSE)**:
   * BFF ãŒã‚¹ã‚­ãƒ¼ãƒæ›´æ–°æ™‚ã€æ¥ç¶šä¸­ã® FE ã«å¯¾ã—ã¦ WebSocket ã¾ãŸã¯ SSE ã§é€šçŸ¥ã‚’é€ä¿¡ã€‚
   * FE ã¯é€šçŸ¥ã‚’å—ã‘å–ã‚Šæ¬¡ç¬¬ã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚¹ã‚­ãƒ¼ãƒã‚’å†å–å¾—ã€‚

## 5. é€šä¿¡ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®æµã‚Œ

### é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«

* **External (FE â†” BFF)**: Connect (HTTP/1.1 JSON)
* **Internal (BFF â†” BE, Services â†” ISR)**: Connect (gRPC Binary æ¨å¥¨ / JSON ã‚‚å¯)

### å¤šå±¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®æˆ¦ç•¥

1. **FE**:
   * `current_user.user_plan` ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã® `user_plan` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®šã€‚
   * å…¥åŠ›å†…å®¹ã‚’ `protovalidate-ts` ã§ãƒã‚§ãƒƒã‚¯ï¼ˆOptimisticï¼‰ã€‚
2. **BFF**:
   * FE ã‹ã‚‰å—ã‘å–ã£ãŸ `user_plan` ã‚’ãã®ã¾ã¾ BE ã«è»¢é€ï¼ˆBFF ã¯ DB ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãªã„ï¼‰ã€‚
   * PoC ã§ã¯èªè¨¼ãƒ»èªå¯ã¯ç°¡æ˜“å®Ÿè£…ã¨ã™ã‚‹ã€‚
3. **BE**:
   * DB ã‹ã‚‰æœ€æ–°ã® `user.plan` ã‚’å†å–å¾—ã€‚
   * ãƒªã‚¯ã‚¨ã‚¹ãƒˆã® `user_plan` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ DB ã®å€¤ã§ä¸Šæ›¸ãã—ã€`protovalidate-go` ã§æœ€çµ‚ç¢ºå®šï¼ˆAuthoritativeï¼‰ã€‚

### è¿½è¨˜ï¼ˆã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆï¼‰

#### **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡**

* **Service Discovery**: ã™ã¹ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆISR, BE, BFF, DBï¼‰ã‚’åŒä¸€ã® Docker Network å†…ã§å®Ÿè¡Œã™ã‚‹ã€‚
* **å†…éƒ¨æ¥ç¶š**: å„ã‚µãƒ¼ãƒ“ã‚¹ã¯ãƒ›ã‚¹ãƒˆå´ã®ãƒãƒ¼ãƒˆã‚’ä»‹ã•ãšã€Docker ã®ã‚µãƒ¼ãƒ“ã‚¹åï¼ˆä¾‹: `db:5432`, `isr:50051`ï¼‰ã‚’ä½¿ç”¨ã—ã¦ç›´æ¥é€šä¿¡ã™ã‚‹ã€‚
* **ãƒ›ã‚¹ãƒˆãƒãƒ¼ãƒˆã®å›ºå®šå‰²ã‚Šå½“ã¦**: å…¨ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒ Docker Compose å†…ã§å®Œçµã™ã‚‹ãŸã‚ã€ãƒ›ã‚¹ãƒˆå´ã¸ã®ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã¯å›ºå®šãƒãƒ¼ãƒˆï¼ˆä¾‹: `5432:5432`, `50051:50051`ï¼‰ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

### README.md ã¸ã®è¨˜è¼‰ï¼ˆé–‹ç™ºè€…å‘ã‘ã‚¬ã‚¤ãƒ‰ï¼‰

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® `README.md` ã«ã€ã“ã®å‹•çš„ãªä»•çµ„ã¿ã‚’ã©ã†æ‰±ã†ã‹ã‚’æ›¸ã„ã¦ãŠãã¨è¦ªåˆ‡ã§ã™ã€‚

> ### ğŸ›  é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
>
> æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ Docker Compose å†…ã§é€šä¿¡ãŒå®Œçµã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚
> ```bash
> # ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•
> docker compose up -d
> ```
>
> **æ¥ç¶šæƒ…å ±:**
>
> * **ã‚³ãƒ³ãƒ†ãƒŠé–“**: `host: db`, `port: 5432`
> * **ãƒ›ã‚¹ãƒˆã‹ã‚‰**: `localhost:5432` (å›ºå®šãƒãƒ¼ãƒˆ)
>


### å…·ä½“çš„ãª `docker-compose.yml` ã®ã‚¤ãƒ¡ãƒ¼ã‚¸

ã“ã®è¨­è¨ˆã‚’ã‚³ãƒ¼ãƒ‰ã«è½ã¨ã—è¾¼ã‚€ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```yaml
services:
  db:
    image: postgres:16-alpine
    ports:
      - "5432:5432" # å›ºå®šãƒãƒ¼ãƒˆ

  isr:
    build: ./services/isr
    environment:
      - CELO_DB_URL=postgres://user:password@db:5432/irs_db # ã‚µãƒ¼ãƒ“ã‚¹åã§æŒ‡å®š
      - CELO_SCHEMA_TARGET=1.0 # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã™ã‚‹ Major.Minor ãƒãƒ¼ã‚¸ãƒ§ãƒ³
    depends_on:
      - db

  be:
    build: ./services/be
    environment:
      - CELO_DB_URL=postgres://user:password@db:5432/be_db
      - CELO_ISR_URL=isr:50051 # ã‚µãƒ¼ãƒ“ã‚¹åã§æŒ‡å®š
      - CELO_SCHEMA_TARGET=1.0 # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã™ã‚‹ Major.Minor ãƒãƒ¼ã‚¸ãƒ§ãƒ³
    depends_on:
      - isr

```
