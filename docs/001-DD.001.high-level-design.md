# Design Doc 1: å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ (High-Level Design) - æ”¹è¨‚ç‰ˆ

## 1. èƒŒæ™¯ã¨èª²é¡Œ

ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã®é‡è¤‡ã€ä¸æ•´åˆã€ãŠã‚ˆã³æ›´æ–°æ™‚ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ã‚¹ãƒˆã‚’æ’é™¤ã™ã‚‹ãŸã‚ã€å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§å‹•çš„ã«åŒæœŸã•ã‚Œã‚‹ã€Œå¥‘ç´„é§†å‹•ï¼ˆContract-Drivenï¼‰ã€ãªã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

## 2. è¨­è¨ˆç›®æ¨™

* **Single Source of Truth**: `.proto` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å”¯ä¸€ã®æ­£è§£ã¨ã™ã‚‹ã€‚
* **Dynamic Schema Distribution**: ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•ãªã—ã§å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«ã‚’æ•°åˆ†ä»¥å†…ã«æ›´æ–°ã™ã‚‹ã€‚
* **Decoupled Registry**: GitHub ã®ãƒ¬ãƒ¼ãƒˆãƒªãƒŸãƒƒãƒˆã‚„èªè¨¼ã‚’éš è”½ã—ã€å†…éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã«æœ€é©åŒ–ã•ã‚ŒãŸã‚¹ã‚­ãƒ¼ãƒé…ä¿¡ã‚’è¡Œã†ã€‚

## 3. ã‚·ã‚¹ãƒ†ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

1. **Schema Source (GitHub)**: ã‚¹ã‚­ãƒ¼ãƒã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ç®¡ç†ã¨ã€CIã«ã‚ˆã‚‹ãƒã‚¤ãƒŠãƒªãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†ã€‚
2. **Internal Schema Registry (ISR) â˜…è¿½åŠ **:
* GitHub ã‹ã‚‰æœ€æ–°ã® `descriptor.bin` ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹**ãƒãƒ–**ã€‚
* BE / BFF ã«å¯¾ã—ã¦ã€ä¸€è²«ã—ãŸã‚¹ã‚­ãƒ¼ãƒé…ä¿¡ API ã‚’æä¾›ã™ã‚‹ã€‚


3. **BFF (TypeScript / Connect-Node)**:
* ISR ã‹ã‚‰ã‚¹ã‚­ãƒ¼ãƒã‚’å–å¾—ãƒ»ä¿æŒã€‚
* ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆFEï¼‰å‘ã‘ã«ã‚¹ã‚­ãƒ¼ãƒã‚’ãƒ—ãƒ­ã‚­ã‚·é…ä¿¡ã™ã‚‹ã€‚


4. **Backend (Go / Connect-Go)**:
* ISR ã‹ã‚‰ã‚¹ã‚­ãƒ¼ãƒã‚’å–å¾—ã€‚
* DB ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ³¨å…¥ã—ãŸæœ€çµ‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã€‚


5. **Frontend (TypeScript / Connect-Web)**:
* BFF ã‚’çµŒç”±ã—ã¦ã‚¹ã‚­ãƒ¼ãƒã‚’å–å¾—ã€‚
* `protovalidate-ts` ã«ã‚ˆã‚‹å³æ™‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’æä¾›ã€‚



## 4. ã‚¹ã‚­ãƒ¼ãƒé…å¸ƒãƒ»åŒæœŸã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

| ã‚¹ãƒ†ãƒƒãƒ— | å‹•ä½œå†…å®¹ | æ‹…å½“ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ |
| --- | --- | --- |
| **1. Build** | `.proto` æ›´æ–°ã‚’æ¤œçŸ¥ã— `descriptor.bin` ã‚’ãƒªãƒªãƒ¼ã‚¹ | GitHub Actions |
| **2. Fetch & Cache** | GitHub API ã‚’å©ãã€ãƒã‚¤ãƒŠãƒªã‚’ãƒ¡ãƒ¢ãƒª/ãƒ‡ã‚£ã‚¹ã‚¯ã«ä¿æŒ | **ISR** |
| **3. Sync (Server)** | ISR ã® API ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã€æ›´æ–°ãŒã‚ã‚Œã°ãƒ›ãƒƒãƒˆã‚¹ãƒ¯ãƒƒãƒ— | BE / BFF |
| **4. Sync (Client)** | BFF ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã€ãƒã‚¤ãƒŠãƒªã‚’ãƒ­ãƒ¼ãƒ‰ | FE |

## 5. é€šä¿¡ãƒ»ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®æµã‚Œ

### é€šä¿¡ãƒ—ãƒ­ãƒˆã‚³ãƒ«

* **External (FE â†” BFF)**: Connect (HTTP/1.1 JSON)
* **Internal (BFF â†” BE, Services â†” ISR)**: Connect (gRPC Binary æ¨å¥¨ / JSON ã‚‚å¯)

### å¤šå±¤ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®æˆ¦ç•¥

1. **FE**: å…¥åŠ›å†…å®¹ã‚’ `protovalidate-ts` ã§ãƒã‚§ãƒƒã‚¯ï¼ˆOptimisticï¼‰ã€‚
2. **BFF**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ `user.plan` ã‚’è£œå®Œã—ã€BE ã¸é€ã‚‹å‰ã«ãƒã‚§ãƒƒã‚¯ï¼ˆEarly Rejectï¼‰ã€‚
3. **BE**: DB ã‹ã‚‰æœ€æ–°ã® `user.plan` ã‚’å†å–å¾—ã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã® `user_plan` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¸Šæ›¸ãã—ã€`protovalidate-go` ã§æœ€çµ‚ç¢ºå®šï¼ˆAuthoritativeï¼‰ã€‚

### è¿½è¨˜ï¼ˆã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆï¼‰

#### **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¨ã‚µãƒ¼ãƒ“ã‚¹é–“é€šä¿¡**

* **Service Discovery**: ã™ã¹ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆISR, BE, BFF, DBï¼‰ã‚’åŒä¸€ã® Docker Network å†…ã§å®Ÿè¡Œã™ã‚‹ã€‚
* **å†…éƒ¨æ¥ç¶š**: å„ã‚µãƒ¼ãƒ“ã‚¹ã¯ãƒ›ã‚¹ãƒˆå´ã®ãƒãƒ¼ãƒˆã‚’ä»‹ã•ãšã€Docker ã®ã‚µãƒ¼ãƒ“ã‚¹åï¼ˆä¾‹: `db:5432`, `isr:50051`ï¼‰ã‚’ä½¿ç”¨ã—ã¦ç›´æ¥é€šä¿¡ã™ã‚‹ã€‚
* **ãƒ›ã‚¹ãƒˆãƒãƒ¼ãƒˆã®å‹•çš„å‰²ã‚Šå½“ã¦**: ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒˆã®è¡çªã‚’é¿ã‘ã‚‹ãŸã‚ã€ãƒ›ã‚¹ãƒˆå´ã¸ã®ãƒãƒ¼ãƒˆãƒãƒƒãƒ”ãƒ³ã‚°ã¯ `0:5432` ã®ã‚ˆã†ã«å‹•çš„å‰²ã‚Šå½“ã¦ã¨ã™ã‚‹ã€‚é–‹ç™ºè€…ãŒå¤–éƒ¨ãƒ„ãƒ¼ãƒ«ã‹ã‚‰ DB ã‚’å‚ç…§ã™ã‚‹å ´åˆã¯ `docker compose port` ã‚³ãƒãƒ³ãƒ‰ã§ãƒãƒ¼ãƒˆã‚’ç‰¹å®šã™ã‚‹ã€‚

### README.md ã¸ã®è¨˜è¼‰ï¼ˆé–‹ç™ºè€…å‘ã‘ã‚¬ã‚¤ãƒ‰ï¼‰

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® `README.md` ã«ã€ã“ã®å‹•çš„ãªä»•çµ„ã¿ã‚’ã©ã†æ‰±ã†ã‹ã‚’æ›¸ã„ã¦ãŠãã¨è¦ªåˆ‡ã§ã™ã€‚

> ### ğŸ›  é–‹ç™ºç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
> 
> 
> æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ Docker Compose å†…ã§é€šä¿¡ãŒå®Œçµã™ã‚‹ã‚ˆã†ã«è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚
> ```bash
> # ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•
> docker compose up -d
> 
> ```
> 
> 

> # DBã®ãƒãƒ¼ãƒˆã‚’ç¢ºèªã™ã‚‹ï¼ˆãƒ›ã‚¹ãƒˆã‹ã‚‰ã®æ¥ç¶šç”¨ï¼‰
> 
> 
> docker compose port db 5432
> ```
> 
> **æ¥ç¶šæƒ…å ±:**
> 
> ```
> 
> 

> * **ã‚³ãƒ³ãƒ†ãƒŠé–“**: `host: db`, `port: 5432`
> * **ãƒ›ã‚¹ãƒˆã‹ã‚‰**: ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã—ãŸãƒãƒ¼ãƒˆã‚’ä½¿ç”¨
> 
> 
> ```
> 
> ```
> 
> 

### å…·ä½“çš„ãª `docker-compose.yml` ã®ã‚¤ãƒ¡ãƒ¼ã‚¸

ã“ã®è¨­è¨ˆã‚’ã‚³ãƒ¼ãƒ‰ã«è½ã¨ã—è¾¼ã‚€ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```yaml
services:
  db:
    image: postgres:16-alpine
    ports:
      - "0:5432" # ãƒ›ã‚¹ãƒˆå´ã®è¡çªã‚’å›é¿

  isr:
    build: ./services/isr
    environment:
      - DB_URL=postgres://user:password@db:5432/irs_db # ã‚µãƒ¼ãƒ“ã‚¹åã§æŒ‡å®š
    depends_on:
      - db

  be:
    build: ./services/be
    environment:
      - DB_URL=postgres://user:password@db:5432/be_db
      - ISR_URL=isr:50051 # ã‚µãƒ¼ãƒ“ã‚¹åã§æŒ‡å®š
    depends_on:
      - isr

```
