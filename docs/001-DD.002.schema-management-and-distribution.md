# Design Doc 2: スキーマ管理・配信パイプライン設計 (Local Push & SemVer)

## 1. 目的

`descriptor.bin` を中央レジストリ (ISR) で管理し、各コンポーネント (FE, BFF, BE) がダウンタイムなしで最新のバリデーションルール (Patch) を適用できる仕組みを構築する。

## 2. バージョニング戦略

本 PoC では **Semantic Versioning** を以下の定義で運用する。

* **Major (vX)**: 破壊的変更（フィールド削除、型変更）。
* **Minor (vY)**: 非破壊的な構造変更（フィールド追加）。
* **Patch (vZ)**: **バリデーションルール (CEL) のみの更新。**
* **原則**: 各アプリは `vX.Y` をターゲットとしてビルドされ、実行時にその系列の最新 `Patch` を取得する。

## 3. コンポーネント設計

### 3.1 ISR (Internal Schema Registry)

* **役割**: スキーマバイナリの保存、検索、配信。
* **Storage**: PostgreSQL を使用し、正規化されたバージョン情報を保持。
* **API (Connect/gRPC)**:
* `UploadSchema`: ローカルスクリプトから `v1.2.3` 等を指定してバイナリを Push。
* `GetLatestPatch`: 指定された `vX.Y` に紐づく最新の `Patch` バイナリを返す。

### 3.2 Local Upload Script

* **役割**: GitHub Actions の振る舞いをローカルでエミュレート。
* **動作**:
1. `buf build` を実行し、`descriptor.bin` を生成。
2. ISR の `UploadSchema` を叩き、セマンティックバージョン（例: `v1.0.1`）と共に送信。

## 4. スキーマ同期メカニズム

### 4.1 サーバーサイド (BE / BFF)

* **初期化**: 起動時に `GetLatestPatch(major_minor: "1.0")` を呼び出し。
* **監視**: 1分間隔で ISR をポーリング。
* **反映**: `version` 文字列が更新されていれば、`protovalidate` エンジンをホットスワップ。

### 4.2 クライアントサイド (FE)

* **経路**: BFF が `/api/v1/schema/latest` エンドポイントを公開（ISR へのプロキシ）。
* **反映**: ブラウザ側でバイナリを Fetch し、`protovalidate-ts` のリポジトリを差し替える。

## 5. データモデル (PostgreSQL)

```sql
CREATE TABLE schemas (
    id          UUID PRIMARY KEY,
    major       INTEGER NOT NULL,
    minor       INTEGER NOT NULL,
    patch       INTEGER NOT NULL,
    full_tag    TEXT NOT NULL,    -- "v1.2.3"
    descriptor  BYTEA NOT NULL,   -- descriptor.bin
    git_sha     TEXT,             -- ローカル時は任意
    created_at  TIMESTAMP DEFAULT now(),
    UNIQUE(major, minor, patch)
);
CREATE INDEX idx_schema_lookup ON schemas (major, minor, patch DESC);
```

## 6. 異常系の設計

* **ISR 停止時**: 各サービスはメモリ上の既存バリデーターで動作を継続。
* **不正スキーマ**: ISR は `UploadSchema` 受信時にバイナリの整合性チェック（パース確認）を行い、不正な場合は保存を拒否する。
