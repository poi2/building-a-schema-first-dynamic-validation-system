# Design Doc 2: スキーマ管理・配信パイプライン設計 (Local Push & SemVer)

## 1. 目的

`descriptor.bin` を中央レジストリ (ISR) で管理し、各コンポーネント (FE, BFF, BE) がダウンタイムなしで最新のバリデーションルール (Patch) を適用できる仕組みを構築する。

## 2. バージョニング戦略

本 PoC では **Semantic Versioning** を以下の定義で運用する。

* **Major (vX)**: 破壊的変更（フィールド削除、型変更）。
* **Minor (vY)**: 非破壊的な構造変更（フィールド追加）。
* **Patch (vZ)**: **バリデーションルール (CEL) のみの更新。**
* **原則**: 各アプリは環境変数 `CELO_SCHEMA_TARGET` (例: `1.0`) で Major.Minor をターゲットとして指定し、実行時にその系列の最新 `Patch` を取得する。

### Major/Minor 変更時の移行戦略

* **本 PoC のスコープ**: Patch レベルの変更（バリデーションルールの更新）のみを扱う。
* **Major/Minor 変更**: Out of Scope。将来的には以下の方法で対応する想定：
  * Blue-Green デプロイメントによるバージョン切り替え
  * `CELO_SCHEMA_TARGET` の更新とアプリケーションの再デプロイ

## 3. コンポーネント設計

### 3.1 ISR (Internal Schema Registry)

* **役割**: スキーマバイナリの保存、検索、配信。
* **Storage**: PostgreSQL を使用し、正規化されたバージョン情報を保持。
* **API (Connect/gRPC)**:
* `UploadSchema`: ローカルスクリプトから `v1.2.3` 等を指定してバイナリを Push。
* `GetLatestPatch`: 指定された `vX.Y` に紐づく最新の `Patch` バイナリを返す。

### 3.2 Local Upload Script

* **役割**: GitHub Actions の振る舞いをローカルでエミュレート。
* **動作**:
  1. `buf build` を実行し、`descriptor.bin` を生成。
  2. ISR の `UploadSchema` を叩き、セマンティックバージョン（例: `v1.0.1`）と共に送信。

## 4. スキーマ同期メカニズム

### 4.1 サーバーサイド (BE)

* **初期化**:
  1. 起動時に ISR から `GetLatestPatch(major: 1, minor: 0)` (CELO_SCHEMA_TARGET から解析) を呼び出し。
  2. ISR から取得できなかった場合、コンテナイメージに同梱された proto をフォールバックとして使用。
* **監視**: 1分間隔で ISR をポーリング。
* **反映**:
  1. `version` 文字列が更新されていれば、`protovalidate` エンジンをホットスワップ。
  2. 更新されたスキーマはプロセスが落ちるまでメモリにキャッシュ。

### 4.2 クライアントサイド (FE)

* **経路**: BE が `/api/v1/schema/latest` エンドポイントを公開（ISR へのプロキシ）。
* **初期化**:
  1. 起動時に BE からスキーマを取得。
  2. 取得できなかった場合、バンドルに同梱された proto をフォールバックとして使用。
* **監視**: 1分間隔で BE をポーリング（PoC では WebSocket/SSE は使用しない）。
* **反映**: ブラウザ側でバイナリを Fetch し、`protovalidate-ts` のバリデーターを差し替える。

## 5. データモデル (PostgreSQL)

```sql
CREATE TABLE schemas (
    id          UUID PRIMARY KEY,
    major       INTEGER NOT NULL,
    minor       INTEGER NOT NULL,
    patch       INTEGER NOT NULL,
    full_tag    TEXT NOT NULL,    -- "v1.2.3"
    descriptor  BYTEA NOT NULL,   -- descriptor.bin
    git_sha     TEXT,             -- ローカル時は任意
    created_at  TIMESTAMP DEFAULT now(),
    UNIQUE(major, minor, patch)
);
CREATE INDEX idx_schema_lookup ON schemas (major, minor, patch DESC);
```

## 6. 異常系の設計とフォールバック戦略

### 6.1 ISR 停止時の動作

* **既存サービス**: メモリ上の既存バリデーターで動作を継続。
* **新規起動**: コンテナイメージに同梱された proto（ビルド時に含める）をフォールバックとして使用。

### 6.2 スキーマ同梱戦略

* **FE/BE のコンテナイメージ**:
  1. ビルド時に ISR から `CELO_SCHEMA_TARGET` に対応する最新の Patch を fetch し、`descriptor.bin` としてイメージに含める。
  2. 各サービスのビルドタイミングがずれて異なる Patch バージョンが同梱される可能性があるが、Patch レベルの差異は機能上問題ない。
  3. ISR から最新 Patch を受け取れた場合は、メモリ上のバリデーターを更新。
  4. ISR から一度も受け取れなかった場合は、イメージに同梱された proto を使用。

### 6.3 不正スキーマの検出

* ISR は `UploadSchema` 受信時にバイナリの整合性チェック（パース確認）を行い、不正な場合は保存を拒否する。
